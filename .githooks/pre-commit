#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

cd "$(git rev-parse --show-toplevel)"

if ! command -v cargo >/dev/null 2>&1; then
  echo "warning: cargo not found in PATH; skipping cargo fmt."
  exit 0
fi

# If rustup available, prefer checking rustfmt; otherwise allow cargo fmt presence
if command -v rustup >/dev/null 2>&1; then
  if ! rustup component list --installed 2>/dev/null | grep -q '^rustfmt'; then
    if ! command -v rustfmt >/dev/null 2>&1; then
      echo "warning: rustfmt not installed. Run: rustup component add rustfmt"
      exit 0
    fi
  fi
fi

if cargo fmt --all -- --check; then
  exit 0
else
  echo
  echo "Running cargo fmt --all..."
  cargo fmt --all
  git add -A
  echo "Formatted and staged changes. Commit halted. Review and re-run commit or use --amend."
  exit 1
fi